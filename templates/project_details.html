{% extends 'base.html' %}
{% block content %}
<div id="project-details">
    <center><h1>{{ company_name }}</h1>
    <h2>Project: {{ project_name }} </h2></center>

    <!-- Buttons for navigation -->
    <button onclick="window.history.back();">Back to Projects</button>
    <button id="pdf-editor-btn" onclick="handlePdfEditor()">PDF Editor</button>
    <button onclick="downloadTableAsCSV()">Download Table</button>

    <!-- Line Items Table -->
    <div id="json-line-items" style="width: 80%; margin: auto; text-align: left;">
        <h3>Line Items</h3>
        {% if project_json and project_json.input %}
            <table id="line-items-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;">Page</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;">Line Item</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;">Length</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;">Width</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;">Height</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;">Note</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;">Price</th>
                    </tr>
                </thead>
                <tbody>
                    {% for page, items in project_json.input.items() %}
                        {% for item in items %}
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">{{ page }}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">{{ item.line_item }}</td>
                            {% if item.metadata and item.metadata.lengthField and item.metadata.breadthField and item.metadata.heightField %}
                                <td style="border: 1px solid #ddd; padding: 8px;">{{ item.metadata.lengthField }}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">{{ item.metadata.breadthField }}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">{{ item.metadata.heightField }}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">{{ item.metadata.paintCostField }}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">{{ item.metadata.noteField }}</td>
                            {% else %}
                                <td colspan="3" style="border: 1px solid #ddd; padding: 8px;">Metadata not available for this item</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No line items available.</p>
        {% endif %}
    </div>

    

</div>

<script>
function handlePdfEditor() {
    const projectData = {
        company_name: "{{ company_name }}",
        project_name: "{{ project_name }}"
    };

    fetch("/cad_pdf_editor", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(projectData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.redirect_url) {
                window.open(data.redirect_url, '_blank');
            } else {
                alert('No PDF found in the specified project path.');
            }
        } else {
            alert(data.message || 'An error occurred.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while communicating with the server.');
    });
}

function downloadTableAsCSV() {
    var table = document.getElementById("line-items-table");
    var csv = [];
    var rows = table.querySelectorAll("tr");

    // Add company and project name to CSV
    csv.push("Company Name: {{ company_name }}");
    csv.push("Project Name: {{ project_name }}\n");

    // Loop through table rows
    for (var i = 0; i < rows.length; i++) {
        var row = [],
            cols = rows[i].querySelectorAll("td, th");

        for (var j = 0; j < cols.length; j++) {
            row.push(cols[j].innerText);
        }

        csv.push(row.join(","));
    }

    // Download CSV
    var csvContent = csv.join("\n");
    var blob = new Blob([csvContent], { type: "text/csv" });
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "{{ company_name }}_{{ project_name }}_line_items.csv";
    link.click();
}
</script>

{% endblock %}
